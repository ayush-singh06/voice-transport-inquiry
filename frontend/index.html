<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BMTC Voice Inquiry</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h1><span class="brand">BMTC Voice Inquiry System</span></h1>
    <div class="search-section">
      <div class="dropdowns">
        <label for="sourceSelect">Source:</label>
        <select id="sourceSelect"></select>
        <label for="destinationInput">Destination:</label>
        <input list="destinationList" id="destinationInput" name="destinationInput" autocomplete="off" placeholder="Enter your destination" />
        <datalist id="destinationList"></datalist>
      </div>
      <button id="searchButton" class="primary-btn">üîç Search</button>
    </div>
    <button id="micButton" class="mic-btn">üé§ Ask About a Bus</button>
    <p id="userQuery" class="hint">Say something like: <i>"Next bus from Majestic to Electronic City"</i></p>
    <p id="result" class="result"></p>
  </div>
  <script>
    const micButton = document.getElementById('micButton');
    const userQuery = document.getElementById('userQuery');
    const result = document.getElementById('result');

    micButton.addEventListener('click', () => {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.start();

      recognition.onresult = async (event) => {
        const transcript = event.results[0][0].transcript;
        userQuery.innerText = `You said: "${transcript}"`;

        try {
          const response = await fetch('/query', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ query: transcript })
          });
          const data = await response.json();
          if (data.answer.includes('Platform')) {
            // Format the answer with clickable platform links
            const formattedAnswer = formatAnswerWithLinks(data.answer);
            result.innerHTML = `üü¢ ${formattedAnswer}`;
          } else {
            result.innerText = `üü¢ ${data.answer || "Sorry, I couldn't find any matching bus."}`;
          }
        } catch (err) {
          result.innerText = '‚ùå Error contacting server.';
          console.error(err);
        }
      };

      recognition.onerror = (event) => {
        result.innerText = '‚ùå Voice recognition error: ' + event.error;
      };
    });

    async function populateStops() {
      const res = await fetch('/stops');
      const data = await res.json();
      const sourceSelect = document.getElementById('sourceSelect');
      data.sources.forEach(stop => {
        const opt = document.createElement('option');
        opt.value = opt.text = stop;
        sourceSelect.appendChild(opt);
      });
      populateDestinations(data.destinations); // <-- Use this for datalist
    }

    function populateDestinations(destinations) {
      const datalist = document.getElementById('destinationList');
      datalist.innerHTML = '';
      destinations.forEach(dest => {
        const option = document.createElement('option');
        option.value = dest;
        datalist.appendChild(option);
      });
    }
    populateStops();
    document.getElementById('searchButton').onclick = async () => {
      const source = document.getElementById('sourceSelect').value;
      const destination = document.getElementById('destinationInput').value; // <-- Use input value
      document.getElementById('userQuery').innerText = `Searching: ${source} to ${destination}`;
      const response = await fetch('/query', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: `from ${source} to ${destination}` })
      });
      const data = await response.json();
      if (data.answer.includes('Platform')) {
        // Format the answer with clickable platform links
        const formattedAnswer = formatAnswerWithLinks(data.answer);
        document.getElementById('result').innerHTML = `üü¢ ${formattedAnswer}`;
      } else {
        document.getElementById('result').innerText = `üü¢ ${data.answer}`;
      }
    };
    function populateDestinations(destinations) {
      const datalist = document.getElementById('destinationList');
      datalist.innerHTML = '';
      destinations.forEach(dest => {
        const option = document.createElement('option');
        option.value = dest;
        datalist.appendChild(option);
      });
    }
    // Call this function with your destinations array after fetching from backend
    const destinationInput = document.getElementById('destinationInput');
    const selectedDestination = destinationInput.value;
    // Use selectedDestination in your search logic
  </script>
  <a href="map.html" class="primary-btn" style="margin-top:18px;display:inline-block;">View Station Map</a>
</body>
</html>
<body>
    <div class="info-container">
        <button class="info-btn" onclick="toggleInfoBox()" aria-label="Show info">i</button>
        <div class="infobox" id="infobox" style="display:none;">
            <strong>About this Webpage</strong><br>
            This is the BMTC Voice Inquiry System. Use the search box to find bus routes from Majestic to anywhere in Bengaluru, or view the map for station platforms. Powered by real-time data and voice search for your convenience.
        </div>
    </div>
    <script>
      function toggleInfoBox() {
        var box = document.getElementById('infobox');
        box.style.display = (box.style.display === 'none' || box.style.display === '') ? 'block' : 'none';
      }
      function displayResults(data) {
        const resultDiv = document.createElement('div');
        result.appendChild(resultDiv);
      }
      
      // Function to format the answer with clickable platform links
      function formatAnswerWithLinks(answer) {
        // Replace "Platform X" with a link to the map
        return answer.replace(/Platform (\d+)/g, function(match, platformNum) {
          return `<a href="map.html?platform=${platformNum}" class="platform-link">Platform ${platformNum}</a>`;
        });
      }
    </script>
</body>
